# 微信公众平台

## 公众号的种类

[区别和形式](http://kf.qq.com/faq/170815aUZjeQ170815mU7bI7.html)

目前公众号主要分为三种：服务号、订阅号、小程序；还有企业微信只针对企业用户使用，暂且不算在内。

| 名称 | 服务对象 | 业务类型 |
|------|---------|-----|
| 服务号 | 企业 | 任意 |
| 订阅号 | 个人或媒体 | 信息传播 |
| 小程序 | 企业 | 任意 |

> 服务号：给企业提供用户管理与业务服务的能力，实现业务扩张。
> 
> 订阅号：给个人或媒体提供信息传播的能力，与读者建立更好的沟通。
> 
> 小程序：作用基本同服务号，比服务号H5应用体验更好，但无法替代非H5的沟通系统，可以实现互补。

## 不同类型公众号的入口归纳

| 名称 | 关注后所在位置 |
|------|---------|
| 服务号 | 联系人列表 |
| 订阅号 | 归纳在订阅号 |
| 小程序 | 归纳在最近使用 |

> 服务号：是以微信用户的一个联系人形式存在的，在聊天记录的列表里可以找到。
>
> 订阅号：被统一归纳在订阅号入口当中，在聊天记录的列表里可以找到订阅号入口，点击入口就会看到所有订阅号。
>
> 小程序：并不在用户的聊天列表当中，毕竟不能与它对话，使用过的小程序在微信的最近使用中可以找到。

## 申请自己的公众号

[微信公众平台首页](https://mp.weixin.qq.com)

对于个人而言，无论是学习还是维护个人公众号，只要不涉及支付环节，注册时订阅号足以。如果需要支付功能，那么需要注册服务号，服务号注册时需要企业相关证书。

### 大致注册流程

![账户注册入口-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/register_entry.png?raw=true)

![注册时类型选择-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/register_type_select.png?raw=true)

![公众号信息填写-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/register_info_setting.png?raw=true)

## 成为开发者

登陆申请好的公众账户，就会进入微信给公众号用户提供的Web后台管理系统，通过这个系统，在页面简单操作即可满足自动回复，消息推送，粉丝管理等需求。

![Web后台系统操作-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/visual_operation.png?raw=true)

当然，如果需要结合自身业务进行定制，那么就需要申请成为开发者，然后调用微信提供的api结合自身业务进行扩展，对于我们而言，要的就是成为开发者！

1. 首先在左侧菜单中找到：开发 => 基本配置
2. 然后接受同意，成为开发者
3. 获取开发者ID(AppID)与开发者密码(AppSecret)，并妥善保存(很重要)
4. 配置URL白名单，把自己的服务器IP填上去，保证只有指定的服务器能获取到access_token(很重要)

![基本配置入口-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/base_settings_entry.png?raw=true)

![同意成为开发者-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/base_settings_developer.png?raw=true)

![启用开发者密码-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/base_settings_id_secret.png?raw=true)

![AppSecret获取时身份认证-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/base_settings_secret_sys.png?raw=true)

![配置URL白名单-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/base_settings_token_ip.png?raw=true)

### 名词简要说明

- AppID：公众应用唯一身份认证
- AppSecret：公众应用密码，需妥善保存
- access_token：调用微信接口所需的凭证，每个接口调用都需要，可通过AppID和AppSecret获取
- URL白名单：增加获取access_token的安全性，当密码泄露时，通过白名单过滤非法请求
- [白名单官方说明](https://mp.weixin.qq.com/cgi-bin/announce?action=getannouncement&key=1495617578&version=1&lang=zh_CN&platform=2)

## 服务器配置

[服务器配置官方文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421135319)

进行服务器配置时，需要拥有自己的外网服务器，并需要编写服务接口与微信服务器进行通信验证，大致步骤如下：

1. 填写URL：自己的服务器域名
2. 填写Token：一个自定义的字符串
3. 填写EncodingAESKey：加密密钥，可以自动生成
4. 选择消息加解密方式
5. 编写认证接口，部署到自己的服务器中
6. 点击提交

### 编写认证接口

下面是认证接口的编写，我么第一次开发时可以先注册测试账户进程开发配置，完毕后再迁移到正式账号，后面在申请测试账号时我们还会用同样的方式编写接口认证测试服务器。

![服务器认证代码逻辑-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/base_settings_server_code_logic.png?raw=true)

```js
const http = require('http');
const url = require('url');
const crypto = require('crypto');

// 服务器配置
const serverConfig = {
    port: 8866
};

// 微信公众测试号
const wxAppInfo = {
    appID: 'wx6526e8044b491ab8',
    appsecret: 'e43f21c9b5c1ea00b435b91102eb04b7',
    token: 'gpf_wx_token'
};

// 这个接口是供wx服务器认证时使用的，由wx那边调用
const server = http.createServer(function(req, rep) {

    // 设置响应的数据与编码格式，这里返回一个普通文本即可
    rep.setHeader('Content-Type', "text/plain;charset=utf-8");

    // 路由
    if(req.method == 'GET') {
        wxAuthentication(req, rep);
    }
    // 默认返回
    else {
        rep.write("你不是微信");
        rep.end();
    }

})
.listen(serverConfig.port, () => {
    console.log(`Node服务已启动，监听端口为${serverConfig.port}`)
})
.on('close', () => {
    console.log(`Node${serverConfig.port}端口服务已终止`)
});

/**
 * 微信server认证:
 * 1 将 token timestamp nonce 三个参数进行字典序排序
 * 2 将 三个参数字符串拼接成一个字符串进行sha1加密
 * 3 将加密后的字符串与signature进行进行对比，如果相同，则返回echostr参数
 * 4 在公众号web页面配置接口url与token，微信就会调用接口进行验证
*/
function wxAuthentication(req, rep) {
    let urlInfo = url.parse(req.url, true);
    let urlQuery = urlInfo.query;

    console.log(urlQuery);
    
    // 接口微信传递的4个参数
    let signature = urlQuery.signature;
    let timestamp = urlQuery.timestamp;
    let nonce = urlQuery.nonce;
    let echostr = urlQuery.echostr;

    // 将 token timestamp nonce 三个参数进行字典序排序并用sha1加密
    let str = [wxAppInfo.token, timestamp, nonce].sort().join('');
    let strSha1 = crypto.createHash('sha1').update(str).digest('hex');

    console.log(`自己加密后的字符串为：${strSha1}`);
    console.log(`微信传入的加密字符串为：${signature}`);
    console.log(`两者比较结果为：${signature == strSha1}`);
    
    // 签名对比，相同则按照微信要求返回echostr参数值
    if(signature == strSha1) {
        rep.write(echostr);
    }else {
        rep.write("你不是微信");
    }

    rep.end();
}
```

## JS安全域名配置

[JS安全域名配置](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/visual_operation.png?raw=true)

如果要开发H5页面，并使用微信提供的JS-API，那么就需要配置JS接口调用安全域名(只能在指定的域名下，才能通过JS调用微信API)，以保证API调用的安全性。

1. 后台管理左侧菜单 => 设置 => 公众号设置
2. 公众号设置页面 => 功能设置Tab => JS接口安全域名设置
3. 下载`MP_verify_nZz3UUDQxD5qKiwT.txt`文件，放置到域名对应的服务器目录，如果用的是nginx放到`/usr/share/nginx/html/`，然后通过域名加文件名的形式进行访问，如果正常得到文件内容，那么测试成功。
4. 把自己的域名或路径配置上去，然后点击保存，微信会立即进行验证，无误后提示保存成功

![公众号设置入口-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/vipcn_settings_entry?raw=true)

![JS接口安全域名设置入口-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/vipcn_settings_jsapi_domain?raw=true)

![JS接口安全域名设置-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/vipcn_settings_jsapi_domain2?raw=true)

![MP文件测试-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/vipcn_settings_jsapi_domain3.png?raw=true)

## 测试账号开通与配置

[测试账户使用参考文档](https://blog.csdn.net/hzw2312/article/details/69664485)

在进行公众号开发时，通常会先在测试账号中进行开发调试，经测试确认无误后，再把新功能切换到正式账号。

1. 后台管理左侧菜单 => 开发 => 开发者工具
2. 开发者工具页面 => 公众平台测试账号
3. 记录测试账号的appID与appsecret
4. 测试账号的服务器配置
5. 测试账号的JS接口安全域名配置
6. 扫一扫关注自己的测试账号，然后会在用户列表里展现
7. 创建几个模板消息，供将来测试使用

![开发者工具入口-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/developer_settings_entry.png?raw=true)

![测试账号入口-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/test_account_entry.png.png?raw=true)

![测试账号配置-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/developer_settings_test_account.png?raw=true)

![关注自己的测试账号-截图](https://github.com/guopengfei116/drop/blob/master/img/wx-vipcn/developer_settings_test_account2.png?raw=true)
